"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const helpers_1 = require("./helpers");
const logger_1 = require("./logger");
const runner_1 = require("./runner");
const migrate_1 = require("./migrate");
/**
 * Construct (asynchronously) a new WorkerUtils instance.
 */
async function makeWorkerUtils(options) {
    const { logger: baseLogger = logger_1.defaultLogger } = options;
    const logger = baseLogger.scope({
        label: "WorkerUtils",
    });
    const { pgPool, release } = await runner_1.withReleasers(async (releasers, release) => ({
        pgPool: await runner_1.assertPool(options, releasers, logger),
        release,
    }));
    const withPgClient = helpers_1.makeWithPgClientFromPool(pgPool);
    const addJob = helpers_1.makeAddJob(withPgClient);
    return {
        withPgClient,
        logger,
        release,
        addJob,
        migrate: () => withPgClient(migrate_1.migrate),
    };
}
exports.makeWorkerUtils = makeWorkerUtils;
/**
 * This function can be used to quickly add a job; however if you need to call
 * this more than once in your process you should instead create a WorkerUtils
 * instance for efficiency and performance sake.
 */
async function quickAddJob(options, identifier, payload = {}, spec = {}) {
    const utils = await makeWorkerUtils(options);
    try {
        return await utils.addJob(identifier, payload, spec);
    }
    finally {
        await utils.release();
    }
}
exports.quickAddJob = quickAddJob;
//# sourceMappingURL=workerUtils.js.map